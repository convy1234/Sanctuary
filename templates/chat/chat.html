{% extends "base.html" %}

{% block content %}
<div class="card" style="padding: 24px;">
    <div class="d-flex" style="justify-content: space-between; align-items: baseline; gap: 12px; flex-wrap: wrap;">
        <div>
            <h1 style="margin: 0;">Chat</h1>
            <p style="margin: 4px 0 0; color: #64748b;">Connect with everyone in your church organization.</p>
        </div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <span class="pill" style="background:#e0f2fe; color:#0ea5e9;">Live</span>
            <span class="pill" style="background:#eef2ff; color:#6366f1;">Session-auth</span>
        </div>
    </div>

    <div class="chat-page" style="display: grid; grid-template-columns: 320px 1fr; gap: 16px; margin-top: 18px; min-height: 520px;">
        <div class="chat-pane" style="border: 1px solid #e2e8f0; border-radius: 14px; overflow: hidden; display: flex; flex-direction: column;">
            <div style="padding: 12px 14px; border-bottom: 1px solid #e2e8f0; background: #f8fafc; display:flex; gap:8px; align-items:center;">
                <input id="chatSearch" type="search" placeholder="Search channels or people" style="flex:1; padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 10px; background:#fff;">
                <button id="chatRefresh" class="pill" style="padding:8px 12px;">Refresh</button>
            </div>
            <div id="chatList" style="flex:1; overflow-y:auto; padding: 4px 0;">
                <div style="padding: 6px 14px; text-transform: uppercase; font-size: 12px; color:#94a3b8; display:flex; justify-content:space-between; align-items:center;">
                    <span>Channels</span>
                    <button id="chatCreateChannel" class="pill" style="padding:4px 8px;">+ Channel</button>
                </div>
                <div id="chatChannelsList"></div>
                <div style="padding: 10px 14px 4px; text-transform: uppercase; font-size: 12px; color:#94a3b8;">Direct</div>
                <div id="chatDMList"></div>
                <div style="padding: 10px 14px 4px; text-transform: uppercase; font-size: 12px; color:#94a3b8;">People</div>
                <div id="chatPeopleList"></div>
            </div>
        </div>

        <div class="chat-pane" style="border: 1px solid #e2e8f0; border-radius: 14px; display: grid; grid-template-rows: auto 1fr auto; min-height: 520px;">
            <div id="chatThreadHeader" style="padding: 14px 16px; border-bottom: 1px solid #e2e8f0; font-weight: 700;">Select a conversation</div>
            <div id="chatThreadBody" style="padding: 14px 16px; overflow-y: auto; background:#f8fafc;">
                <p style="color:#94a3b8;">Choose a channel or start a direct chat to begin.</p>
            </div>
            <div style="padding: 12px 14px; border-top: 1px solid #e2e8f0; display: flex; gap: 10px; background:#fff;">
                <input id="chatMessageInput" type="text" placeholder="Type a message..." style="flex:1; padding: 10px 12px; border:1px solid #cbd5e1; border-radius: 10px;">
                <button id="chatSendButton" class="pill" style="padding: 10px 14px;" disabled>Send</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const summaryUrl = "/chat/widget/summary/";
    const messagesUrl = (type, id) => `/chat/widget/${type}/${id}/messages/`;
    const sendUrl = "/chat/widget/send/";
    const startDmUrl = "/chat/widget/dm/start/";

    const channelsEl = document.getElementById("chatChannelsList");
    const dmsEl = document.getElementById("chatDMList");
    const peopleEl = document.getElementById("chatPeopleList");
    const searchEl = document.getElementById("chatSearch");
    const refreshBtn = document.getElementById("chatRefresh");
    const createChannelBtn = document.getElementById("chatCreateChannel");
    const headerEl = document.getElementById("chatThreadHeader");
    const bodyEl = document.getElementById("chatThreadBody");
    const messageInput = document.getElementById("chatMessageInput");
    const sendBtn = document.getElementById("chatSendButton");

    let summaryCache = { channels: [], dms: [], members: [] };
    let activeThread = null;
    let pollHandle = null;

    function csrfToken() {
        const m = document.cookie.match(/csrftoken=([^;]+)/);
        return m ? decodeURIComponent(m[1]) : "";
    }

    function renderEmpty(targetEl, text) {
        const wrap = document.createElement("div");
        wrap.style.padding = "8px 14px";
        wrap.style.color = "#94a3b8";
        wrap.textContent = text;
        targetEl.appendChild(wrap);
    }

    function renderList(items, targetEl, type) {
        targetEl.innerHTML = "";
        if (!items.length) {
            renderEmpty(
                targetEl,
                type === "person"
                    ? "No other members yet. Invite someone to start chatting."
                    : "Nothing yet."
            );
            return;
        }

        items.forEach(item => {
            const div = document.createElement("div");
            div.className = "chat-list-row";
            div.style.padding = "10px 14px";
            div.style.cursor = "pointer";
            div.style.display = "flex";
            div.style.justifyContent = "space-between";
            div.style.alignItems = "center";
            div.onmouseenter = () => div.style.background = "#f1f5f9";
            div.onmouseleave = () => div.style.background = "transparent";
            div.onclick = () => {
                if (type === "person") {
                    startDirectChat(item);
                } else {
                    openThread(item.type, item.id, item.display_name || item.name);
                }
            };

            const title = document.createElement("div");
            title.style.fontWeight = 600;
            title.textContent = item.display_name || item.name;
            div.appendChild(title);

            if (item.unread_count) {
                const badge = document.createElement("span");
                badge.className = "pill";
                badge.style.background = "#fee2e2";
                badge.style.color = "#b91c1c";
                badge.textContent = item.unread_count;
                div.appendChild(badge);
            }

            targetEl.appendChild(div);
        });
    }

    function loadSummary() {
        fetch(summaryUrl, { credentials: "include" })
            .then(r => r.json())
            .then(data => {
                summaryCache = data;
                if (data.error) {
                    channelsEl.innerHTML = "";
                    dmsEl.innerHTML = "";
                    peopleEl.innerHTML = "";
                    renderEmpty(channelsEl, data.error);
                    return;
                }
                const q = (searchEl.value || "").toLowerCase();
                const filterFn = item => (item.name || "").toLowerCase().includes(q) || (item.display_name || "").toLowerCase().includes(q);
                renderList((data.channels || []).filter(filterFn), channelsEl, "channel");
                renderList((data.dms || []).filter(filterFn), dmsEl, "dm");
                renderList((data.members || []).filter(m => (m.name || "").toLowerCase().includes(q)), peopleEl, "person");
            })
            .catch(err => {
                channelsEl.innerHTML = "";
                dmsEl.innerHTML = "";
                peopleEl.innerHTML = "";
                renderEmpty(channelsEl, "Unable to load chat data.");
                console.error("chat summary error", err);
            });
    }

    function openThread(type, id, title) {
        activeThread = { type, id };
        headerEl.textContent = title || "Conversation";
        sendBtn.disabled = false;
        bodyEl.innerHTML = "<p style='color:#94a3b8;'>Loading...</p>";
        fetch(messagesUrl(type, id), { credentials: "include" })
            .then(r => r.json())
            .then(data => renderMessages(data.messages || []))
            .catch(err => {
                bodyEl.innerHTML = "<p style='color:#ef4444;'>Unable to load messages.</p>";
                console.error("chat messages error", err);
            });
        if (pollHandle) clearInterval(pollHandle);
        pollHandle = setInterval(() => {
            if (activeThread) {
                fetch(messagesUrl(type, id), { credentials: "include" })
                    .then(r => r.json())
                    .then(data => renderMessages(data.messages || []))
                    .catch(() => {});
            }
        }, 7000);
    }

    function renderMessages(msgs) {
        bodyEl.innerHTML = "";
        msgs.forEach(m => {
            const wrap = document.createElement("div");
            wrap.className = "chat-bubble";
            wrap.style.margin = "8px 0";
            wrap.style.maxWidth = "85%";
            wrap.style.padding = "10px 12px";
            wrap.style.borderRadius = "12px";
            wrap.style.background = m.is_me ? "#0f4c81" : "#fff";
            wrap.style.color = m.is_me ? "#fff" : "#0f172a";
            wrap.style.marginLeft = m.is_me ? "auto" : "0";
            const meta = document.createElement("div");
            meta.style.fontSize = "12px";
            meta.style.opacity = 0.8;
            meta.textContent = `${m.sender} â€¢ ${new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
            const text = document.createElement("div");
            text.textContent = m.content;
            wrap.appendChild(meta);
            wrap.appendChild(text);
            bodyEl.appendChild(wrap);
        });
        bodyEl.scrollTop = bodyEl.scrollHeight;
    }

    function sendMessage() {
        if (!activeThread) return;
        const content = (messageInput.value || "").trim();
        if (!content) return;
        const form = new URLSearchParams();
        form.append("thread_type", activeThread.type);
        form.append("thread_id", activeThread.id);
        form.append("content", content);
        fetch(sendUrl, {
            method: "POST",
            headers: { "X-CSRFToken": csrfToken(), "Content-Type": "application/x-www-form-urlencoded" },
            body: form.toString(),
            credentials: "include",
        })
            .then(r => r.json())
            .then(() => {
                messageInput.value = "";
                if (activeThread) {
                    fetch(messagesUrl(activeThread.type, activeThread.id), { credentials: "include" })
                        .then(r => r.json())
                        .then(data => renderMessages(data.messages || []));
                }
            })
            .catch(err => console.error("send error", err));
    }

    function startDirectChat(person) {
        const form = new URLSearchParams();
        form.append("user_id", person.id);
        fetch(startDmUrl, {
            method: "POST",
            headers: { "X-CSRFToken": csrfToken(), "Content-Type": "application/x-www-form-urlencoded" },
            body: form.toString(),
            credentials: "include",
        })
            .then(r => r.json())
            .then(data => {
                if (data.thread_id) {
                    openThread("dm", data.thread_id, person.name);
                    loadSummary();
                }
            })
            .catch(err => console.error("start dm error", err));
    }

    sendBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    searchEl.addEventListener("input", () => loadSummary());
    refreshBtn.addEventListener("click", () => loadSummary());
    createChannelBtn.addEventListener("click", () => {
        const name = prompt("Channel name (e.g., general)");
        if (!name) return;
        const payload = new URLSearchParams();
        payload.append("name", name);
        fetch("/chat/widget/channel/create/", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded", "X-CSRFToken": csrfToken() },
            body: payload.toString(),
            credentials: "include",
        })
            .then(r => r.json())
            .then(() => loadSummary())
            .catch(err => console.error("create channel error", err));
    });

    loadSummary();
})();
</script>
{% endblock %}
