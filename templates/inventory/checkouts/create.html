<!-- templates/inventory/checkouts/create.html -->
{% extends "base.html" %}
{% load humanize %}

{% block title %}Checkout Item - Inventory{% endblock %}

{% block content %}
<div class="main">
    <!-- Header -->
    <div class="section-card" style="margin-bottom:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <p class="muted" style="margin:0;">{{ organization.name }}</p>
                <h1 style="margin:6px 0 0;">Checkout Inventory Item</h1>
            </div>
            <div>
                <a href="{% url 'inventory_checkout_list' %}" class="pill">‚Üê Back to Checkouts</a>
            </div>
        </div>
    </div>

    <!-- Form -->
    <div class="content-grid" style="grid-template-columns:2fr 1fr; gap:20px;">
        <div class="section-card">
            <form method="post" style="display:flex; flex-direction:column; gap:24px;">
                {% csrf_token %}
                
                <!-- Error Messages -->
                {% if errors %}
                <div style="background:#fee2e2; color:#dc2626; padding:16px; border-radius:10px; margin-bottom:20px;">
                    <strong style="display:block; margin-bottom:8px;">Please fix the following errors:</strong>
                    <ul style="margin:0; padding-left:20px;">
                        {% for field, error in errors.items %}
                        <li><strong>{{ field|title }}</strong>: {{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- Item Selection -->
                <div>
                    <h3 style="margin-top:0; margin-bottom:16px;">Item Selection</h3>
                    <div>
                        <label for="item">Select Item *</label>
                        <select id="item" name="item" required 
                                onchange="updateStockInfo(this.value)" 
                                style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px;">
                            <option value="">-- Select an item --</option>
                            {% for item in items %}
                            <option value="{{ item.id }}" 
                                    {% if data.item == item.id|stringformat:"s" %}selected{% endif %}
                                    data-quantity="{{ item.quantity }}"
                                    data-sku="{{ item.sku }}"
                                    data-location="{{ item.location|default:'Not set' }}">
                                {{ item.name }} ({{ item.quantity }} in stock)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Stock Info Display -->
                    <div id="stock-info" style="margin-top:12px; display:none;">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; background:#f9fafb; padding:12px; border-radius:8px;">
                            <div>
                                <div style="font-size:12px; color:var(--muted);">Available Stock</div>
                                <div id="available-stock" style="font-weight:700; font-size:16px;">0</div>
                            </div>
                            <div>
                                <div style="font-size:12px; color:var(--muted);">SKU</div>
                                <div id="item-sku" style="font-weight:700; font-size:16px;">-</div>
                            </div>
                            <div>
                                <div style="font-size:12px; color:var(--muted);">Location</div>
                                <div id="item-location" style="font-weight:700; font-size:16px;">-</div>
                            </div>
                            <div>
                                <div style="font-size:12px; color:var(--muted);">Status</div>
                                <div id="item-status" style="font-weight:700; font-size:16px; color:#059669;">In Stock</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Checkout Details -->
                <div>
                    <h3 style="margin-top:0; margin-bottom:16px;">Checkout Details</h3>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                        <div>
                            <label for="member">Member *</label>
                            <select id="member" name="member" required>
                                <option value="">-- Select member --</option>
                                {% for member in members %}
                                <option value="{{ member.id }}" 
                                        {% if data.member == member.id|stringformat:"s" %}selected{% endif %}>
                                    {{ member.full_name }} ({{ member.email|default:member.phone }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="department">Department *</label>
                            <select id="department" name="department" required>
                                <option value="">-- Select department --</option>
                                {% for department in departments %}
                                <option value="{{ department.id }}" 
                                        {% if data.department == department.id|stringformat:"s" %}selected{% endif %}>
                                    {{ department.name }} ({{ department.code }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="quantity">Quantity *</label>
                            <input type="number" id="quantity" name="quantity" 
                                   value="{{ data.quantity|default:1 }}" 
                                   min="1" step="1" required
                                   onchange="validateQuantity()">
                            <div style="font-size:12px; color:var(--muted); margin-top:4px;">
                                Maximum: <span id="max-quantity">0</span>
                            </div>
                        </div>
                        <div>
                            <label for="due_date">Due Date</label>
                            <input type="date" id="due_date" name="due_date" 
                                   value="{{ data.due_date|default:'' }}">
                            <div style="font-size:12px; color:var(--muted); margin-top:4px;">
                                When item should be returned
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top:16px;">
                        <label for="purpose">Purpose *</label>
                        <input type="text" id="purpose" name="purpose" 
                               value="{{ data.purpose|default:'' }}" 
                               placeholder="What will this be used for?" required
                               style="width:100%;">
                    </div>
                    
                    <div style="margin-top:16px;">
                        <label for="event_name">Related Event (Optional)</label>
                        <input type="text" id="event_name" name="event_name" 
                               value="{{ data.event_name|default:'' }}" 
                               placeholder="Church event name"
                               style="width:100%;">
                    </div>
                </div>
                
                <!-- Notes -->
                <div>
                    <h3 style="margin-top:0; margin-bottom:16px;">Additional Information</h3>
                    <textarea id="notes" name="notes" rows="4" style="width:100%;"
                              placeholder="Additional notes about this checkout...">{{ data.notes|default:'' }}</textarea>
                </div>
                
                <!-- Form Actions -->
                <div style="display:flex; justify-content:space-between; align-items:center; padding-top:20px; border-top:1px solid var(--border);">
                    <div>
                        <a href="{% url 'inventory_checkout_list' %}" style="color:var(--muted);">Cancel</a>
                    </div>
                    <div>
                        <button type="submit" id="submit-btn" 
                                style="background:var(--primary); color:white; padding:12px 24px; border:none; border-radius:10px; font-weight:600; cursor:pointer;">
                            Checkout Item
                        </button>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Help Sidebar -->
        <div class="section-card">
            <h3 style="margin-top:0;">Checkout Guidelines</h3>
            
            <div style="margin-bottom:20px;">
                <div style="font-weight:700; margin-bottom:8px; color:#dc2626;">Required Fields</div>
                <ul style="margin:0; padding-left:20px; font-size:14px; color:var(--muted);">
                    <li>Item</li>
                    <li>Member</li>
                    <li>Department</li>
                    <li>Quantity</li>
                    <li>Purpose</li>
                </ul>
            </div>
            
            <div style="margin-bottom:20px;">
                <div style="font-weight:700; margin-bottom:8px;">Checkout Process</div>
                <div style="font-size:14px; color:var(--muted);">
                    <p style="margin:4px 0;">1. Select item from inventory</p>
                    <p style="margin:4px 0;">2. Choose member receiving item</p>
                    <p style="margin:4px 0;">3. Select responsible department</p>
                    <p style="margin:4px 0;">4. Set quantity and due date</p>
                    <p style="margin:4px 0;">5. Specify purpose of checkout</p>
                </div>
            </div>
            
            <div style="margin-bottom:20px;">
                <div style="font-weight:700; margin-bottom:8px;">Important Notes</div>
                <div style="font-size:14px; color:var(--muted);">
                    <p style="margin:4px 0;">‚Ä¢ <strong>Due Date</strong>: Set when item should be returned</p>
                    <p style="margin:4px 0;">‚Ä¢ <strong>Purpose</strong>: Be specific about usage</p>
                    <p style="margin:4px 0;">‚Ä¢ <strong>Quantity</strong>: Cannot exceed available stock</p>
                    <p style="margin:4px 0;">‚Ä¢ Checkouts can be tracked and managed later</p>
                </div>
            </div>
            
            <div style="border-top:1px solid var(--border); padding-top:16px;">
                <div style="font-weight:700; margin-bottom:8px;">Quick Links</div>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <a href="{% url 'inventory_item_list' %}" class="quick-action" style="padding:12px;">
                        üìã View All Items
                    </a>
                    <a href="{% url 'inventory_checkout_list' %}" class="quick-action" style="padding:12px;">
                        üìã Active Checkouts
                    </a>
                    <a href="{% url 'inventory_dashboard' %}" class="quick-action" style="padding:12px;">
                        üìä Inventory Dashboard
                    </a>
                </div>
            </div>
            
            <!-- Recent Checkouts -->
            <div style="border-top:1px solid var(--border); padding-top:16px; margin-top:16px;">
                <div style="font-weight:700; margin-bottom:8px;">Recent Checkouts</div>
                {% if recent_checkouts %}
                    <div style="max-height:200px; overflow-y:auto;">
                        {% for checkout in recent_checkouts|slice:":3" %}
                        <div class="list-row" style="padding:8px 0; border-bottom:1px solid var(--border);">
                            <div>
                                <div style="font-weight:600; font-size:13px;">{{ checkout.item.name }}</div>
                                <div style="font-size:11px; color:var(--muted);">
                                    {{ checkout.member.full_name }} ‚Ä¢ {{ checkout.quantity }} units
                                </div>
                            </div>
                            <div style="font-size:11px; color:var(--muted);">
                                {{ checkout.checkout_date|date:"M d" }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div style="text-align:center; padding:12px; color:var(--muted); font-size:14px;">
                        No recent checkouts
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: var(--text);
        font-size: 14px;
    }
    
    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.2s ease;
    }
    
    input[type="text"]:focus,
    input[type="number"]:focus,
    input[type="date"]:focus,
    select:focus,
    textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236b7280' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 16px;
        padding-right: 40px;
    }
    
    button[type="submit"] {
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    button[type="submit"]:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }
    
    button[type="submit"]:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
    }
    
    .quick-action {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 8px;
        text-decoration: none;
        color: inherit;
        transition: all 0.2s ease;
    }
    
    .quick-action:hover {
        background: var(--primary-soft);
        border-color: var(--primary);
        transform: translateY(-1px);
    }
    
    .list-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .content-grid {
        display: grid;
        gap: 20px;
    }
    
    .section-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 24px;
    }
    
    .muted {
        color: var(--muted);
        font-size: 14px;
    }
    
    .pill {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        background: var(--primary-soft);
        color: var(--primary);
        border-radius: 20px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: background 0.2s ease;
    }
    
    .pill:hover {
        background: var(--primary);
        color: white;
    }
</style>

<script>
// Store items data for JavaScript access
const itemsData = {
    {% for item in items %}
    "{{ item.id }}": {
        id: "{{ item.id }}",
        name: "{{ item.name|escapejs }}",
        quantity: {{ item.quantity }},
        sku: "{{ item.sku|default:'No SKU'|escapejs }}",
        location: "{{ item.location|default:'Not set'|escapejs }}",
        reorder_level: {{ item.reorder_level|default:0 }}
    },
    {% endfor %}
};

// Update stock information when item is selected
function updateStockInfo(itemId) {
    const stockInfo = document.getElementById('stock-info');
    const availableStock = document.getElementById('available-stock');
    const itemSku = document.getElementById('item-sku');
    const itemLocation = document.getElementById('item-location');
    const itemStatus = document.getElementById('item-status');
    const maxQuantity = document.getElementById('max-quantity');
    const quantityInput = document.getElementById('quantity');
    
    if (itemId && itemsData[itemId]) {
        const item = itemsData[itemId];
        
        // Show stock info
        stockInfo.style.display = 'block';
        
        // Update values
        availableStock.textContent = item.quantity;
        itemSku.textContent = item.sku;
        itemLocation.textContent = item.location;
        maxQuantity.textContent = item.quantity;
        
        // Update status color
        if (item.quantity <= 0) {
            itemStatus.textContent = 'Out of Stock';
            itemStatus.style.color = '#dc2626';
            quantityInput.disabled = true;
            quantityInput.value = 0;
            document.getElementById('submit-btn').disabled = true;
        } else if (item.quantity <= item.reorder_level) {
            itemStatus.textContent = 'Low Stock';
            itemStatus.style.color = '#f59e0b';
            quantityInput.disabled = false;
            quantityInput.max = item.quantity;
            document.getElementById('submit-btn').disabled = false;
        } else {
            itemStatus.textContent = 'In Stock';
            itemStatus.style.color = '#059669';
            quantityInput.disabled = false;
            quantityInput.max = item.quantity;
            document.getElementById('submit-btn').disabled = false;
        }
        
        // Reset quantity to 1 if it exceeds available stock
        if (parseInt(quantityInput.value) > item.quantity) {
            quantityInput.value = 1;
        }
        quantityInput.max = item.quantity;
        
    } else {
        // Hide stock info if no item selected
        stockInfo.style.display = 'none';
        quantityInput.disabled = false;
        document.getElementById('submit-btn').disabled = false;
    }
    
    // Validate quantity
    validateQuantity();
}

// Validate quantity input
function validateQuantity() {
    const quantityInput = document.getElementById('quantity');
    const selectedItem = document.getElementById('item').value;
    const submitBtn = document.getElementById('submit-btn');
    
    if (selectedItem && itemsData[selectedItem]) {
        const maxQuantity = itemsData[selectedItem].quantity;
        const currentQuantity = parseInt(quantityInput.value) || 0;
        
        if (currentQuantity > maxQuantity) {
            quantityInput.style.borderColor = '#dc2626';
            quantityInput.style.boxShadow = '0 0 0 3px rgba(220, 38, 38, 0.1)';
            submitBtn.disabled = true;
            submitBtn.style.background = '#9ca3af';
            
            // Show warning
            if (!document.getElementById('quantity-warning')) {
                const warning = document.createElement('div');
                warning.id = 'quantity-warning';
                warning.style.color = '#dc2626';
                warning.style.fontSize = '12px';
                warning.style.marginTop = '4px';
                warning.textContent = `Quantity cannot exceed ${maxQuantity} (available stock)`;
                quantityInput.parentNode.appendChild(warning);
            }
        } else {
            quantityInput.style.borderColor = '';
            quantityInput.style.boxShadow = '';
            submitBtn.disabled = false;
            submitBtn.style.background = '';
            
            // Remove warning if exists
            const warning = document.getElementById('quantity-warning');
            if (warning) {
                warning.remove();
            }
        }
    }
}

// Set minimum date for due date (today)
document.addEventListener('DOMContentLoaded', function() {
    // Set today as minimum date for due date
    const today = new Date().toISOString().split('T')[0];
    const dueDateInput = document.getElementById('due_date');
    if (dueDateInput && !dueDateInput.value) {
        dueDateInput.min = today;
        
        // Set default due date to 7 days from now
        const defaultDueDate = new Date();
        defaultDueDate.setDate(defaultDueDate.getDate() + 7);
        const defaultDueDateStr = defaultDueDate.toISOString().split('T')[0];
        dueDateInput.value = defaultDueDateStr;
    }
    
    // If item is pre-selected from URL parameter, update stock info
    const selectedItem = document.getElementById('item').value;
    if (selectedItem) {
        updateStockInfo(selectedItem);
    }
    
    // Auto-focus on first input
    document.getElementById('item').focus();
    
    // Validate form on submit
    const form = document.querySelector('form');
    form.addEventListener('submit', function(event) {
        const selectedItem = document.getElementById('item').value;
        const quantity = parseInt(document.getElementById('quantity').value) || 0;
        
        if (!selectedItem) {
            alert('Please select an item to checkout');
            event.preventDefault();
            return;
        }
        
        if (itemsData[selectedItem] && quantity > itemsData[selectedItem].quantity) {
            alert(`Cannot checkout ${quantity} units. Only ${itemsData[selectedItem].quantity} available.`);
            event.preventDefault();
            return;
        }
        
        if (quantity <= 0) {
            alert('Quantity must be greater than 0');
            event.preventDefault();
            return;
        }
    });
});
</script>
{% endblock %}