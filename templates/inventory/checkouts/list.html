<!-- templates/inventory/checkouts/list.html -->
{% extends "base.html" %}
{% load humanize %}

{% block title %}Checkouts - Inventory{% endblock %}

{% block content %}
<div class="main">
    <!-- Header with Actions -->
    <div class="section-card" style="margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
        <div>
            <p class="muted" style="margin:0;">{{ organization.name }}</p>
            <h1 style="margin:6px 0 0;">Inventory Checkouts</h1>
        </div>
        <div class="actions">
            <a href="{% url 'inventory_checkout_create' %}" class="pill">+ New Checkout</a>
            <a href="{% url 'inventory_dashboard' %}" class="pill" style="background:#4f46e5;">ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â°ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¸ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã¢â‚¬Å“ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â  Dashboard</a>
        </div>
    </div>

    <!-- Stats Summary -->
    <div class="content-grid" style="margin-bottom:20px; grid-template-columns:repeat(4, 1fr);">
        <div class="stat-card">
            <div class="stat-label">Active Checkouts</div>
            <div class="stat-value">{{ checkouts.count }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Overdue</div>
            <div class="stat-value" style="color:#dc2626;">
                {{ overdue_count|default:0 }}
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">This Month</div>
            <div class="stat-value">{{ this_month_count|default:0 }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Items Out</div>
            <div class="stat-value">{{ total_items_out|default:0 }}</div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="card" style="margin-bottom:14px;">
        <form method="get" style="display:grid; grid-template-columns:1fr auto auto auto; gap:12px; align-items:end;">
            <div>
                <label for="search">Search Checkouts</label>
                <input type="text" id="search" name="search" placeholder="Item, member, purpose..." 
                       value="{{ request.GET.search|default:'' }}">
            </div>
            <div>
                <label for="status">Status</label>
                <select id="status" name="status">
                    <option value="">All Status</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                    <option value="overdue" {% if status_filter == 'overdue' %}selected{% endif %}>Overdue</option>
                    <option value="returned" {% if status_filter == 'returned' %}selected{% endif %}>Returned</option>
                    <option value="lost" {% if status_filter == 'lost' %}selected{% endif %}>Lost</option>
                    <option value="damaged" {% if status_filter == 'damaged' %}selected{% endif %}>Damaged</option>
                </select>
            </div>
            <div>
                <label for="member">Member</label>
                <select id="member" name="member">
                    <option value="">All Members</option>
                    {% for member in members %}
                    <option value="{{ member.id }}" {% if member_id == member.id|stringformat:"s" %}selected{% endif %}>
                        {{ member.full_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div style="display:flex; gap:8px;">
                <button type="submit">Filter</button>
                <a href="{% url 'inventory_checkout_list' %}" style="padding:12px 16px; border:1px solid var(--border); border-radius:10px;">Clear</a>
            </div>
        </form>
        
        <!-- Quick Filters -->
        <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
            <a href="?status=active" class="badge {% if status_filter == 'active' %}active{% endif %}">Active</a>
            <a href="?status=overdue" class="badge overdue {% if status_filter == 'overdue' %}active{% endif %}">Overdue</a>
            <a href="?status=returned" class="badge returned {% if status_filter == 'returned' %}active{% endif %}">Returned</a>
            <a href="?overdue=true" class="badge warning {% if overdue_only %}active{% endif %}">Show Overdue Only</a>
        </div>
    </div>

    <!-- Checkouts Table -->
    <div class="section-card">
        {% if checkouts %}
            <div style="overflow-x:auto;">
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="border-bottom:2px solid var(--border);">
                            <th style="text-align:left; padding:12px; font-weight:700;">Item</th>
                            <th style="text-align:left; padding:12px; font-weight:700;">Member</th>
                            <th style="text-align:left; padding:12px; font-weight:700;">Quantity</th>
                            <th style="text-align:left; padding:12px; font-weight:700;">Dates</th>
                            <th style="text-align:left; padding:12px; font-weight:700;">Status</th>
                            <th style="text-align:left; padding:12px; font-weight:700;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for checkout in checkouts %}
                        <tr style="border-bottom:1px solid var(--border); {% if checkout.is_overdue %}background:#fef2f2;{% endif %}">
                            <td style="padding:12px;">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    {% if checkout.item.image %}
                                    <div style="width:36px; height:36px; border-radius:8px; overflow:hidden;">
                                        <img src="{{ checkout.item.image.url }}" alt="{{ checkout.item.name }}" 
                                             style="width:100%; height:100%; object-fit:cover;">
                                    </div>
                                    {% endif %}
                                    <div>
                                        <strong>{{ checkout.item.name }}</strong>
                                        <div class="muted" style="font-size:12px;">
                                            {{ checkout.department.name }}
                                            {% if checkout.purpose %}ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¢ {{ checkout.purpose|truncatechars:30 }}{% endif %}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td style="padding:12px;">
                                <div>
                                    <strong>{{ checkout.member.full_name }}</strong>
                                    <div class="muted" style="font-size:12px;">
                                        {{ checkout.member.email|default:checkout.member.phone|default:"No contact" }}
                                    </div>
                                </div>
                            </td>
                            <td style="padding:12px;">
                                <div style="font-weight:700;">{{ checkout.quantity }}</div>
                                {% if checkout.returned_quantity > 0 %}
                                <div class="muted" style="font-size:12px;">
                                    Returned: {{ checkout.returned_quantity }}
                                </div>
                                {% endif %}
                            </td>
                            <td style="padding:12px;">
                                <div style="font-size:13px;">
                                    <div><strong>Out:</strong> {{ checkout.checkout_date|date:"M d, Y" }}</div>
                                    {% if checkout.due_date %}
                                    <div><strong>Due:</strong> {{ checkout.due_date|date:"M d, Y" }}</div>
                                    {% endif %}
                                    {% if checkout.returned_at %}
                                    <div><strong>Returned:</strong> {{ checkout.returned_at|date:"M d, Y" }}</div>
                                    {% endif %}
                                </div>
                            </td>
                            <td style="padding:12px;">
                                <span class="status-badge status-{{ checkout.status }}">
                                    {{ checkout.get_status_display }}
                                </span>
                                {% if checkout.is_overdue %}
                                <div style="color:#dc2626; font-size:11px; margin-top:4px;">
                                    {{ checkout.days_overdue }} days overdue
                                </div>
                                {% endif %}
                            </td>
                            <td style="padding:12px;">
                                <div style="display:flex; gap:6px;">
                                    <a href="{% url 'inventory_item_detail' checkout.item.id %}" 
                                       style="padding:6px 10px; background:var(--primary-soft); border-radius:6px; font-size:12px;"
                                       title="View Item">
                                        ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â°ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¸ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã¢â‚¬Å“ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¦
                                    </a>
                                    {% if checkout.status == 'active' or checkout.status == 'overdue' %}
                                    <a href="#" onclick="showReturnModal('{{ checkout.id }}', '{{ checkout.item.name|escapejs }}', '{{ checkout.member.full_name|escapejs }}', '{{ checkout.quantity }}')"
                                       style="padding:6px 10px; background:#d1fae5; border-radius:6px; font-size:12px;"
                                       title="Return Item">
                                        ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â©ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¯ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¸
                                    </a>
                                    {% endif %}
                                    {% if checkout.status == 'active' %}
                                    <a href="#" onclick="showExtendModal('{{ checkout.id }}', '{{ checkout.item.name|escapejs }}', '{{ checkout.due_date|date:"Y-m-d" }}')"
                                       style="padding:6px 10px; background:#e0e7ff; border-radius:6px; font-size:12px;"
                                       title="Extend Due Date">
                                        ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â°ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¸ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã¢â‚¬Å“ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â¦
                                    </a>
                                    {% endif %}
                                    <a href="#"
                                       onclick="showCheckoutDetails(this)"
                                       data-checkout-id="{{ checkout.id }}"
                                       data-item-id="{{ checkout.item.id }}"
                                       data-member-id="{{ checkout.member.id }}"
                                       data-item-name="{{ checkout.item.name|escape }}"
                                       data-member-name="{{ checkout.member.full_name|escape }}"
                                       data-quantity="{{ checkout.quantity }}"
                                       data-status="{{ checkout.status }}"
                                       data-status-display="{{ checkout.get_status_display|escape }}"
                                       data-checkout-date="{{ checkout.checkout_date|date:'M d, Y' }}"
                                       data-due-date="{{ checkout.due_date|date:'M d, Y' }}"
                                       data-returned-at="{{ checkout.returned_at|date:'M d, Y' }}"
                                       data-days-overdue="{{ checkout.days_overdue|default:0 }}"
                                       data-purpose="{{ checkout.purpose|default_if_none:''|escape }}"
                                       data-event="{{ checkout.event_name|default_if_none:''|escape }}"
                                       data-notes="{{ checkout.notes|default_if_none:''|escape }}"
                                       data-return-notes="{{ checkout.return_notes|default_if_none:''|escape }}"
                                       style="padding:6px 10px; background:#f3f4f6; border-radius:6px; font-size:12px;"
                                       title="View Details">
                                        ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â°ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¸ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¹Ã…â€œÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¯ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¸
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            {% if checkouts.has_other_pages %}
            <div style="display:flex; justify-content:center; margin-top:20px; padding-top:20px; border-top:1px solid var(--border);">
                <div style="display:flex; gap:8px; align-items:center;">
                    {% if checkouts.has_previous %}
                    <a href="?page={{ checkouts.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if member_id %}&member={{ member_id }}{% endif %}{% if overdue_only %}&overdue=true{% endif %}" 
                       class="pill">ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â  Previous</a>
                    {% endif %}
                    
                    <span style="padding:8px 16px; background:var(--primary-soft); border-radius:8px; font-size:14px;">
                        Page {{ checkouts.number }} of {{ checkouts.paginator.num_pages }}
                    </span>
                    
                    {% if checkouts.has_next %}
                    <a href="?page={{ checkouts.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if member_id %}&member={{ member_id }}{% endif %}{% if overdue_only %}&overdue=true{% endif %}" 
                       class="pill">Next ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â‚¬Å¾Ã‚Â¢</a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
        {% else %}
            <div style="text-align:center; padding:40px 20px;">
                <div style="font-size:48px; margin-bottom:16px;">ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â°ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¸ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã¢â‚¬Å“ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¤</div>
                <h3 style="margin:0 0 8px;">No checkouts found</h3>
                <p class="muted" style="margin-bottom:20px;">
                    {% if status_filter or member_id or overdue_only %}
                        No checkouts match your filters
                    {% else %}
                        Start by creating your first checkout
                    {% endif %}
                </p>
                <a href="{% url 'inventory_checkout_create' %}" class="pill">+ Create First Checkout</a>
            </div>
        {% endif %}
    </div>

    <!-- Summary Cards -->
    <div class="content-grid" style="margin-top:20px; grid-template-columns:1fr 1fr; gap:20px;">
        <!-- Overdue Checkouts -->
        <div class="section-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h3 style="margin:0; color:#dc2626;">ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¡ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¯ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¸ Overdue Checkouts</h3>
                <a href="?status=overdue" class="muted" style="font-size:14px;">View All ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â‚¬Å¾Ã‚Â¢</a>
            </div>
            
            {% if overdue_checkouts %}
                <div style="max-height:200px; overflow-y:auto;">
                    {% for checkout in overdue_checkouts|slice:":5" %}
                    <div class="list-row" style="border-left:4px solid #dc2626;">
                        <div>
                            <strong>{{ checkout.item.name }}</strong>
                            <div class="muted" style="font-size:12px;">
                                {{ checkout.member.full_name }} ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¢ {{ checkout.days_overdue }} days overdue
                            </div>
                        </div>
                        <a href="#" onclick="showReturnModal('{{ checkout.id }}', '{{ checkout.item.name|escapejs }}', '{{ checkout.member.full_name|escapejs }}', '{{ checkout.quantity }}')"
                           class="badge" style="background:#dc2626; color:white; font-size:11px;">
                            Return
                        </a>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div style="text-align:center; padding:20px;">
                    <div style="font-size:32px; margin-bottom:12px;">ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã¢â‚¬Â¦ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â¦</div>
                    <p class="muted">No overdue checkouts</p>
                </div>
            {% endif %}
        </div>

        <!-- Recent Activity -->
        <div class="section-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h3 style="margin:0;">ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â°ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¸ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã¢â‚¬Å“ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â¹ Recent Activity</h3>
                <span class="muted" style="font-size:14px;">Today</span>
            </div>
            
            {% if today_checkouts %}
                <div style="max-height:200px; overflow-y:auto;">
                    {% for checkout in today_checkouts|slice:":5" %}
                    <div class="list-row">
                        <div>
                            <strong>{{ checkout.item.name }}</strong>
                            <div class="muted" style="font-size:12px;">
                                {{ checkout.member.full_name }} ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¡Ãƒâ€šÃ‚Â¬ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¢ {{ checkout.quantity }} units
                            </div>
                        </div>
                        <span class="status-badge status-{{ checkout.status }}" style="font-size:10px;">
                            {{ checkout.get_status_display }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div style="text-align:center; padding:20px;">
                    <div style="font-size:32px; margin-bottom:12px;">ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â°ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¸ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€¦Ã¢â‚¬Å“ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â¦</div>
                    <p class="muted">No activity today</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Return Modal -->
<div id="return-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; padding:24px; border-radius:12px; width:90%; max-width:500px;">
        <h3 style="margin-top:0;">Return Item</h3>
        <p id="return-modal-description"></p>
        
        <form id="return-form" method="post" action="{% url 'inventory_checkout_return' '00000000-0000-0000-0000-000000000000' %}" data-action-template="{% url 'inventory_checkout_return' '00000000-0000-0000-0000-000000000000' %}" style="display:flex; flex-direction:column; gap:16px;">
            {% csrf_token %}
            <input type="hidden" id="return-checkout-id" name="checkout_id">
            
            <div>
                <label for="returned_quantity">Quantity Returning *</label>
                <input type="number" id="returned_quantity" name="returned_quantity" 
                       min="1" step="1" required style="width:100%;">
                <div class="muted" style="font-size:12px; margin-top:4px;">
                    Maximum: <span id="max-return-quantity">0</span> units
                </div>
            </div>
            
            <div>
                <label for="returned_condition">Return Condition *</label>
                <select id="returned_condition" name="returned_condition" style="width:100%;" required>
                    <option value="">Select condition</option>
                    <option value="new">New</option>
                    <option value="excellent">Excellent</option>
                    <option value="good">Good</option>
                    <option value="fair">Fair</option>
                    <option value="poor">Poor</option>
                    <option value="repair">Needs Repair</option>
                </select>
            </div>
            
            <div>
                <label for="return_notes">Return Notes</label>
                <textarea id="return_notes" name="return_notes" rows="3" style="width:100%;"
                          placeholder="Notes about the return condition..."></textarea>
            </div>
            
            <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px;">
                <button type="button" onclick="closeReturnModal()" 
                        style="padding:10px 20px; border:1px solid var(--border); border-radius:8px; background:white;">
                    Cancel
                </button>
                <button type="submit" 
                        style="padding:10px 20px; background:#10b981; color:white; border:none; border-radius:8px;">
                    Confirm Return
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Extend Due Date Modal -->
<div id="extend-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; padding:24px; border-radius:12px; width:90%; max-width:400px;">
        <h3 style="margin-top:0;">Extend Due Date</h3>
        <p id="extend-modal-description"></p>
        
        <form id="extend-form" method="post" action="{% url 'inventory_checkout_extend' '00000000-0000-0000-0000-000000000000' %}" data-action-template="{% url 'inventory_checkout_extend' '00000000-0000-0000-0000-000000000000' %}" style="display:flex; flex-direction:column; gap:16px;">
            {% csrf_token %}
            <input type="hidden" id="extend-checkout-id" name="checkout_id">
            
            <div>
                <label for="new_due_date">New Due Date *</label>
                <input type="date" id="new_due_date" name="new_due_date" 
                       required style="width:100%;">
            </div>
            
            <div>
                <label for="extend_reason">Reason for Extension</label>
                <textarea id="extend_reason" name="extend_reason" rows="2" style="width:100%;"
                          placeholder="Why are you extending the due date?"></textarea>
            </div>
            
            <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px;">
                <button type="button" onclick="closeExtendModal()" 
                        style="padding:10px 20px; border:1px solid var(--border); border-radius:8px; background:white;">
                    Cancel
                </button>
                <button type="submit" 
                        style="padding:10px 20px; background:#3b82f6; color:white; border:none; border-radius:8px;">
                    Extend Due Date
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Checkout Details Modal -->
<div id="details-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; padding:24px; border-radius:12px; width:90%; max-width:600px; max-height:80vh; overflow-y:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">Checkout Details</h3>
            <button onclick="closeDetailsModal()" 
                    style="background:none; border:none; font-size:20px; cursor:pointer;">ÃƒÆ’Ã†â€™Ãƒâ€ Ã¢â‚¬â„¢ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬ÃƒÂ¢Ã¢â€šÂ¬</button>
        </div>
        
        <div id="details-content">
            <!-- Details will be loaded here via AJAX -->
            <div style="text-align:center; padding:40px;">
                <div class="spinner"></div>
                <p>Loading details...</p>
            </div>
        </div>
        
        <div style="display:flex; justify-content:flex-end; margin-top:20px;">
            <button onclick="closeDetailsModal()" 
                    style="padding:10px 20px; border:1px solid var(--border); border-radius:8px; background:white;">
                Close
            </button>
        </div>
    </div>
</div>

<style>
    .stat-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
    }
    
    .stat-label {
        font-size: 14px;
        color: var(--muted);
        margin-bottom: 8px;
    }
    
    .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--primary-dark);
    }
    
    .badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        text-decoration: none;
        display: inline-block;
        transition: all 0.2s ease;
    }
    
    .badge:hover {
        opacity: 0.8;
    }
    
    .badge.active {
        background: var(--primary);
        color: white;
    }
    
    .badge.overdue {
        background: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
    }
    
    .badge.returned {
        background: #f0f9ff;
        color: #0369a1;
        border: 1px solid #bae6fd;
    }
    
    .badge.warning {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fde68a;
    }
    
    .status-badge {
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        display: inline-block;
    }
    
    .status-active {
        background: #d1fae5;
        color: #065f46;
    }
    
    .status-overdue {
        background: #fee2e2;
        color: #dc2626;
    }
    
    .status-returned {
        background: #dbeafe;
        color: #1e40af;
    }
    
    .status-lost {
        background: #f3f4f6;
        color: #374151;
    }
    
    .status-damaged {
        background: #fef3c7;
        color: #92400e;
    }
    
    .list-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid var(--border);
    }
    
    .list-row:last-child {
        border-bottom: none;
    }
    
    .content-grid {
        display: grid;
        gap: 20px;
    }
    
    .section-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 24px;
    }
    
    .card {
        background: white;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 20px;
    }
    
    .muted {
        color: #6b7280;
        font-size: 14px;
    }
    
    .pill {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        background: #e0e7ff;
        color: #4f46e5;
        border-radius: 20px;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .pill:hover {
        background: #4f46e5;
        color: white;
    }
    
    label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: var(--text);
        font-size: 14px;
    }
    
    input, select, textarea {
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 14px;
    }
    
    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<script>
// Show return modal
function showReturnModal(checkoutId, itemName, memberName, quantity) {
    const modal = document.getElementById('return-modal');
    const description = document.getElementById('return-modal-description');
    const checkoutIdInput = document.getElementById('return-checkout-id');
    const returnedQuantity = document.getElementById('returned_quantity');
    const maxReturnQuantity = document.getElementById('max-return-quantity');
    
    // Update modal content
    description.textContent = `Return ${itemName} checked out by ${memberName}`;
    checkoutIdInput.value = checkoutId;
    returnedQuantity.value = quantity;
    returnedQuantity.max = quantity;
    maxReturnQuantity.textContent = quantity;
    
    // Update form action URL
    const form = document.getElementById('return-form');
    const returnTemplate = form.dataset.actionTemplate || form.action;
    form.dataset.actionTemplate = returnTemplate;
    form.action = returnTemplate.replace('00000000-0000-0000-0000-000000000000', checkoutId);
    
    // Show modal
    modal.style.display = 'flex';
}

// Close return modal
function closeReturnModal() {
    document.getElementById('return-modal').style.display = 'none';
}

// Show extend modal
function showExtendModal(checkoutId, itemName, currentDueDate) {
    const modal = document.getElementById('extend-modal');
    const description = document.getElementById('extend-modal-description');
    const checkoutIdInput = document.getElementById('extend-checkout-id');
    const newDueDateInput = document.getElementById('new_due_date');
    
    // Update modal content
    description.textContent = `Extend due date for ${itemName}`;
    checkoutIdInput.value = checkoutId;
    
    // Set minimum date (tomorrow)
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    newDueDateInput.min = tomorrowStr;
    
    // If current due date exists and is in the future, use it as default
    if (currentDueDate) {
        const currentDate = new Date(currentDueDate);
        const now = new Date();
        if (currentDate > now) {
            newDueDateInput.value = currentDueDate;
        } else {
            // Set default to 7 days from now
            const defaultDate = new Date();
            defaultDate.setDate(defaultDate.getDate() + 7);
            newDueDateInput.value = defaultDate.toISOString().split('T')[0];
        }
    } else {
        // Set default to 7 days from now
        const defaultDate = new Date();
        defaultDate.setDate(defaultDate.getDate() + 7);
        newDueDateInput.value = defaultDate.toISOString().split('T')[0];
    }
    
    // Update form action URL
    const form = document.getElementById('extend-form');
    const extendTemplate = form.dataset.actionTemplate || form.action;
    form.dataset.actionTemplate = extendTemplate;
    form.action = extendTemplate.replace('00000000-0000-0000-0000-000000000000', checkoutId);
    
    // Show modal
    modal.style.display = 'flex';
}

// Close extend modal
function closeExtendModal() {
    document.getElementById('extend-modal').style.display = 'none';
}

// Show checkout details modal (with AJAX loading)
function showCheckoutDetails(triggerOrId) {
    const modal = document.getElementById('details-modal');
    const content = document.getElementById('details-content');
    const data = triggerOrId && triggerOrId.dataset ? triggerOrId.dataset : null;

    // If we have inline data, render without an API call
    if (data && data.itemName) {
        const esc = (value) => {
            if (value === undefined || value === null) return '';
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#39;');
        };

        const section = (label, value) => {
            if (!value) return '';
            return `<div style="margin-bottom:16px;">
                        <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">${label}</div>
                        <div style="white-space:pre-line;">${esc(value)}</div>
                    </div>`;
        };

        const dueDateBlock = data.dueDate ? `<div><div style="font-size:11px; color:var(--muted);">Due Date</div><div>${esc(data.dueDate)}</div></div>` : '';
        const returnedBlock = data.returnedAt ? `<div><div style="font-size:11px; color:var(--muted);">Returned Date</div><div>${esc(data.returnedAt)}</div></div>` : '';
        const overdueBlock = data.daysOverdue && Number(data.daysOverdue) > 0 ? `<div><div style="font-size:11px; color:var(--muted);">Days Overdue</div><div style="color:#dc2626;">${esc(data.daysOverdue)} days</div></div>` : '';

        content.innerHTML = `
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                <div><div style="font-size:12px; color:var(--muted);">Item</div><div style="font-weight:700; font-size:16px;">${esc(data.itemName)}</div></div>
                <div><div style="font-size:12px; color:var(--muted);">Member</div><div style="font-weight:700; font-size:16px;">${esc(data.memberName)}</div></div>
                <div><div style="font-size:12px; color:var(--muted);">Quantity</div><div style="font-weight:700; font-size:16px;">${esc(data.quantity)}</div></div>
                <div><div style="font-size:12px; color:var(--muted);">Status</div><div><span class="status-badge status-${esc(data.status)}">${esc(data.statusDisplay || data.status)}</span></div></div>
            </div>
            <div style="background:#f9fafb; padding:16px; border-radius:8px; margin-bottom:20px;">
                <div style="font-size:12px; color:var(--muted); margin-bottom:8px;">Dates</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div><div style="font-size:11px; color:var(--muted);">Checkout Date</div><div>${esc(data.checkoutDate)}</div></div>
                    ${dueDateBlock}
                    ${returnedBlock}
                    ${overdueBlock}
                </div>
            </div>
            ${section('Purpose', data.purpose)}
            ${section('Related Event', data.event)}
            ${section('Notes', data.notes)}
            ${section('Return Notes', data.returnNotes)}
            <div style="display:flex; gap:8px; margin-top:20px;">
                <a href="/inventory/items/${esc(data.itemId)}/" style="padding:8px 16px; background:var(--primary-soft); border-radius:6px; font-size:12px; text-decoration:none;">View Item</a>
                <a href="/member/members/${esc(data.memberId)}/" style="padding:8px 16px; background:#e0e7ff; border-radius:6px; font-size:12px; text-decoration:none;">View Member</a>
            </div>
        `;
        modal.style.display = 'flex';
        return;
    }
    
    // Show loading spinner (fallback when inline data is unavailable)
    content.innerHTML = `
        <div style="text-align:center; padding:40px;">
            <div class="spinner"></div>
            <p>Loading details...</p>
        </div>
    `;
    
    // Fetch checkout details via AJAX
    fetch(`/inventory/api/checkouts/${triggerOrId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                content.innerHTML = `
                    <div style="text-align:center; padding:40px; color:#dc2626;">
                        <div style="font-size:48px; margin-bottom:16px;">ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã¢â‚¬Â¦ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢</div>
                        <p>${data.error}</p>
                    </div>
                `;
                return;
            }
            
            // Format the checkout details
            const checkout = data;
            content.innerHTML = `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                    <div>
                        <div style="font-size:12px; color:var(--muted);">Item</div>
                        <div style="font-weight:700; font-size:16px;">${checkout.item_name}</div>
                    </div>
                    <div>
                        <div style="font-size:12px; color:var(--muted);">Member</div>
                        <div style="font-weight:700; font-size:16px;">${checkout.member_name}</div>
                    </div>
                    <div>
                        <div style="font-size:12px; color:var(--muted);">Quantity</div>
                        <div style="font-weight:700; font-size:16px;">${checkout.quantity}</div>
                    </div>
                    <div>
                        <div style="font-size:12px; color:var(--muted);">Status</div>
                        <div>
                            <span class="status-badge status-${checkout.status}">
                                ${checkout.status_display}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div style="background:#f9fafb; padding:16px; border-radius:8px; margin-bottom:20px;">
                    <div style="font-size:12px; color:var(--muted); margin-bottom:8px;">Dates</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div>
                            <div style="font-size:11px; color:var(--muted);">Checkout Date</div>
                            <div>${checkout.checkout_date_formatted}</div>
                        </div>
                        ${checkout.due_date ? `
                        <div>
                            <div style="font-size:11px; color:var(--muted);">Due Date</div>
                            <div>${checkout.due_date_formatted}</div>
                        </div>
                        ` : ''}
                        ${checkout.returned_at ? `
                        <div>
                            <div style="font-size:11px; color:var(--muted);">Returned Date</div>
                            <div>${checkout.returned_at_formatted}</div>
                        </div>
                        ` : ''}
                        ${checkout.days_overdue > 0 ? `
                        <div>
                            <div style="font-size:11px; color:var(--muted);">Days Overdue</div>
                            <div style="color:#dc2626;">${checkout.days_overdue} days</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                
                ${checkout.purpose ? `
                <div style="margin-bottom:16px;">
                    <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">Purpose</div>
                    <div>${checkout.purpose}</div>
                </div>
                ` : ''}
                
                ${checkout.event_name ? `
                <div style="margin-bottom:16px;">
                    <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">Related Event</div>
                    <div>${checkout.event_name}</div>
                </div>
                ` : ''}
                
                ${checkout.notes ? `
                <div style="margin-bottom:16px;">
                    <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">Notes</div>
                    <div style="white-space:pre-line;">${checkout.notes}</div>
                </div>
                ` : ''}
                
                ${checkout.return_notes ? `
                <div style="margin-bottom:16px;">
                    <div style="font-size:12px; color:var(--muted); margin-bottom:4px;">Return Notes</div>
                    <div style="white-space:pre-line;">${checkout.return_notes}</div>
                </div>
                ` : ''}
                
                <div style="display:flex; gap:8px; margin-top:20px;">
                    <a href="/inventory/items/${checkout.item_id}/" 
                       style="padding:8px 16px; background:var(--primary-soft); border-radius:6px; font-size:12px; text-decoration:none;">
                        View Item
                    </a>
                    <a href="/church/members/${checkout.member_id}/" 
                       style="padding:8px 16px; background:#e0e7ff; border-radius:6px; font-size:12px; text-decoration:none;">
                        View Member
                    </a>
                </div>
            `;
        })
        .catch(error => {
            content.innerHTML = `
                <div style="text-align:center; padding:40px; color:#dc2626;">
                    <div style="font-size:48px; margin-bottom:16px;">ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¢ÃƒÆ’Ã¢â‚¬Â¦Ãƒâ€šÃ‚Â¡ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â ÃƒÆ’Ã†â€™Ãƒâ€šÃ‚Â¯ÃƒÆ’Ã¢â‚¬Å¡Ãƒâ€šÃ‚Â¸</div>
                    <p>Error loading details</p>
                    <p style="font-size:12px;">${error.message}</p>
                </div>
            `;
        });
    
    // Show modal
    modal.style.display = 'flex';
}

// Close details modal
function closeDetailsModal() {
    document.getElementById('details-modal').style.display = 'none';
}

// Close modals when clicking outside
window.onclick = function(event) {
    const returnModal = document.getElementById('return-modal');
    const extendModal = document.getElementById('extend-modal');
    const detailsModal = document.getElementById('details-modal');
    
    if (event.target === returnModal) {
        closeReturnModal();
    }
    if (event.target === extendModal) {
        closeExtendModal();
    }
    if (event.target === detailsModal) {
        closeDetailsModal();
    }
}

// Set minimum date for due date extension (tomorrow)
document.addEventListener('DOMContentLoaded', function() {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    
    const extendDateInput = document.getElementById('new_due_date');
    if (extendDateInput) {
        extendDateInput.min = tomorrowStr;
    }
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        // Escape key closes modals
        if (event.key === 'Escape') {
            closeReturnModal();
            closeExtendModal();
            closeDetailsModal();
        }
        
        // Ctrl/Cmd + F focuses on search
        if ((event.ctrlKey || event.metaKey) && event.key === 'f') {
            event.preventDefault();
            document.getElementById('search').focus();
        }
    });
});
</script>
{% endblock %}
