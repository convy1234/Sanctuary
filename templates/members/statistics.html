{% extends "base.html" %}
{% block title %}Member Statistics - {{ organization.name }}{% endblock %}

{% block head_extra %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }
    .chart-container {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 24px;
        margin-bottom: 20px;
        box-shadow: 0 8px 20px rgba(15,23,42,0.06);
    }
    .insight-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: var(--radius);
        padding: 24px;
        margin-bottom: 20px;
    }
    .insight-card h3 {
        margin-top: 0;
        color: white;
    }
    .trend-up { color: #10b981; }
    .trend-down { color: #ef4444; }
    .trend-neutral { color: var(--muted); }
</style>
{% endblock %}

{% block content %}
<div class="main">
    <!-- Header -->
    <div class="section-card" style="margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
        <div>
            <p class="muted" style="margin:0;">{{ organization.name }}</p>
            <h1 style="margin:6px 0 0;">Member Statistics</h1>
        </div>
        <div class="actions">
            <a href="{% url 'member_list' %}" class="pill">â† Back to Members</a>
            <button onclick="window.print()" class="pill" style="background:#4f46e5;">ğŸ“„ Print Report</button>
        </div>
    </div>

    <!-- Key Insights -->
    <div class="insight-card">
        <h3>ğŸ“ˆ Key Insights</h3>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-top:16px;">
            <div>
                <div style="font-size:14px; opacity:0.9;">Total Membership</div>
                <div style="font-size:32px; font-weight:800; margin:8px 0;">{{ stats.total_members }}</div>
                <div style="font-size:14px; opacity:0.9;">
                    {% with growth=stats.total_members|add:"-100" %}
                        {% if growth > 0 %}
                            <span class="trend-up">â†‘ {{ growth }} growth</span>
                        {% elif growth < 0 %}
                            <span class="trend-down">â†“ {{ growth|slice:"1:" }} decline</span>
                        {% else %}
                            <span class="trend-neutral">â†’ Steady</span>
                        {% endif %}
                    {% endwith %}
                </div>
            </div>
            <div>
                <div style="font-size:14px; opacity:0.9;">Active Engagement</div>
                <div style="font-size:32px; font-weight:800; margin:8px 0;">{{ stats.active_members }}</div>
                <div style="font-size:14px; opacity:0.9;">
                    {% with rate=stats.active_members|floatformat:0 %}
                        {{ rate }}% of total
                    {% endwith %}
                </div>
            </div>
            <div>
                <div style="font-size:14px; opacity:0.9;">Family Units</div>
                <div style="font-size:32px; font-weight:800; margin:8px 0;">{{ stats.family_count }}</div>
                <div style="font-size:14px; opacity:0.9;">Average {{ stats.avg_family_size|default:"-" }} per family</div>
            </div>
            <div>
                <div style="font-size:14px; opacity:0.9;">Departments</div>
                <div style="font-size:32px; font-weight:800; margin:8px 0;">{{ stats.department_count }}</div>
                <div style="font-size:14px; opacity:0.9;">{{ stats.avg_dept_size|default:"-" }} avg members</div>
            </div>
        </div>
    </div>

    <!-- Summary Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total Members</div>
            <div class="stat-value">{{ stats.total_members }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Active Members</div>
            <div class="stat-value">{{ stats.active_members }}</div>
            <div class="muted">{{ stats.active_percentage|default:"0" }}% of total</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">New Members</div>
            <div class="stat-value">{{ stats.new_members }}</div>
            <div class="muted">Last 30 days</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Inactive</div>
            <div class="stat-value">{{ stats.inactive_members }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Visitors</div>
            <div class="stat-value">{{ stats.visitor_count }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Families</div>
            <div class="stat-value">{{ stats.family_count }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Departments</div>
            <div class="stat-value">{{ stats.department_count }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Campuses</div>
            <div class="stat-value">{{ stats.campus_count }}</div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="content-grid">
        <!-- Status Distribution -->
        <div class="chart-container">
            <h3 style="margin-top:0;">Member Status Distribution</h3>
            <div style="height:200px; display:flex; align-items:end; gap:20px; margin-top:20px;">
                {% with total=stats.total_members %}
                    {% if total > 0 %}
                        <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
                            <div style="background:#3b82f6; width:40px; height:{{ stats.active_members|floatformat:2 }}px; border-radius:6px 6px 0 0;"></div>
                            <div style="margin-top:8px; font-weight:600;">Active</div>
                            <div class="muted">{{ stats.active_members }}</div>
                        </div>
                        <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
                            <div style="background:#10b981; width:40px; height:{{ stats.new_members|floatformat:2 }}px; border-radius:6px 6px 0 0;"></div>
                            <div style="margin-top:8px; font-weight:600;">New</div>
                            <div class="muted">{{ stats.new_members }}</div>
                        </div>
                        <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
                            <div style="background:#6b7280; width:40px; height:{{ stats.inactive_members|floatformat:2 }}px; border-radius:6px 6px 0 0;"></div>
                            <div style="margin-top:8px; font-weight:600;">Inactive</div>
                            <div class="muted">{{ stats.inactive_members }}</div>
                        </div>
                        <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
                            <div style="background:#f59e0b; width:40px; height:{{ stats.visitor_count|floatformat:2 }}px; border-radius:6px 6px 0 0;"></div>
                            <div style="margin-top:8px; font-weight:600;">Visitors</div>
                            <div class="muted">{{ stats.visitor_count }}</div>
                        </div>
                    {% else %}
                        <div style="text-align:center; width:100%; padding:40px;">
                            <div style="font-size:48px; margin-bottom:12px;">ğŸ“Š</div>
                            <p class="muted">No data available yet</p>
                        </div>
                    {% endif %}
                {% endwith %}
            </div>
        </div>

        <!-- Gender Distribution -->
        <div class="chart-container">
            <h3 style="margin-top:0;">Gender Distribution</h3>
            <div style="display:flex; align-items:center; justify-content:center; height:200px;">
                {% if stats.gender_male or stats.gender_female %}
                    <div style="display:flex; gap:40px; align-items:center;">
                        <div style="text-align:center;">
                            <div style="width:100px; height:100px; border-radius:50%; background:#3b82f6; 
                                        display:grid; place-items:center; color:white; font-size:24px; font-weight:800;">
                                {{ stats.gender_male|default:"0" }}
                            </div>
                            <div style="margin-top:12px; font-weight:600;">Male</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="width:100px; height:100px; border-radius:50%; background:#ec4899; 
                                        display:grid; place-items:center; color:white; font-size:24px; font-weight:800;">
                                {{ stats.gender_female|default:"0" }}
                            </div>
                            <div style="margin-top:12px; font-weight:600;">Female</div>
                        </div>
                    </div>
                {% else %}
                    <div style="text-align:center;">
                        <div style="font-size:48px; margin-bottom:12px;">ğŸ‘¥</div>
                        <p class="muted">Gender data not available</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Department Breakdown -->
    <div class="chart-container">
        <h3 style="margin-top:0;">Department Memberships</h3>
        {% if stats.department_stats %}
            <div style="display:grid; gap:12px; margin-top:16px;">
                {% for dept_name, dept_data in stats.department_stats.items %}
                    <div>
                        <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                            <span>{{ dept_name }}</span>
                            <span style="font-weight:600;">{{ dept_data.member_count }} members</span>
                        </div>
                        <div style="height:8px; background:#e5e7eb; border-radius:4px; overflow:hidden;">
                            <div style="height:100%; background:var(--primary); width:{% widthratio dept_data.member_count stats.total_members 100 %}%;"></div>
                        </div>
                        {% if dept_data.leader %}
                            <div class="muted" style="margin-top:4px; font-size:13px;">Leader: {{ dept_data.leader }}</div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="text-align:center; padding:40px;">
                <div style="font-size:48px; margin-bottom:12px;">ğŸ¢</div>
                <p class="muted">No department data available</p>
            </div>
        {% endif %}
    </div>

    <!-- Monthly Growth -->
    <div class="chart-container">
        <h3 style="margin-top:0;">Monthly Growth</h3>
        {% if stats.member_growth %}
            <div style="height:200px; display:flex; align-items:end; gap:8px; margin-top:20px; padding:0 20px;">
                {% for month, count in stats.member_growth.items %}
                    <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
                        <div style="background:var(--primary); width:30px; height:{{ count|add:"10" }}px; border-radius:6px 6px 0 0;"></div>
                        <div style="margin-top:8px; font-size:12px; transform:rotate(-45deg); white-space:nowrap;">{{ month }}</div>
                        <div style="margin-top:20px; font-weight:600;">{{ count }}</div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div style="text-align:center; padding:40px;">
                <div style="font-size:48px; margin-bottom:12px;">ğŸ“ˆ</div>
                <p class="muted">No growth data available yet</p>
            </div>
        {% endif %}
    </div>

    <!-- Data Export -->
    <div class="section-card" style="margin-top:20px;">
        <h3 style="margin-top:0;">ğŸ“¥ Data Export</h3>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <button style="background:#10b981;">Export as CSV</button>
            <button style="background:#3b82f6;">Export as PDF</button>
            <button style="background:#6b7280;">Print Report</button>
            <button style="background:#f59e0b;" onclick="location.reload()">Refresh Data</button>
        </div>
        <p class="muted" style="margin-top:12px;">Last updated: {% now "F j, Y g:i A" %}</p>
    </div>
</div>

<script>
// Auto-refresh every 5 minutes
setTimeout(() => {
    if(confirm('Refresh statistics data?')) {
        location.reload();
    }
}, 300000);
</script>
{% endblock %}