{% extends "base.html" %}
{% block title %}Edit {{ member.full_name }} - {{ organization.name }}{% endblock %}

{% block head_extra %}
<style>
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }
    .form-section {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 22px;
        box-shadow: 0 8px 20px rgba(15,23,42,0.06);
    }
    .form-section h3 {
        margin-top: 0;
        margin-bottom: 18px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--border);
        color: var(--primary);
    }
    .required::after {
        content: " *";
        color: #dc2626;
    }
    .photo-upload {
        border: 2px dashed var(--border);
        border-radius: var(--radius);
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.2s;
    }
    .photo-upload:hover {
        border-color: var(--primary);
    }
    .photo-preview {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 12px;
        border: 3px solid var(--border);
    }
    .current-photo {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
    }
    .danger-zone {
        background: #fee2e2;
        border: 2px solid #dc2626;
        border-radius: var(--radius);
        padding: 20px;
        margin-top: 30px;
    }
</style>
{% endblock %}

{% block content %}
<div class="main">
    <!-- Header -->
    <div class="section-card" style="margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; align-items:center; gap:16px;">
            <div class="avatar" style="width:50px; height:50px;">
                {% if member.photo %}
                    <img src="{{ member.photo.url }}" alt="{{ member.full_name }}" 
                         style="width:100%; height:100%; border-radius:50%; object-fit:cover;">
                {% else %}
                    {{ member.first_name|slice:":1"|upper }}{{ member.last_name|slice:":1"|upper }}
                {% endif %}
            </div>
            <div>
                <h1 style="margin:0 0 4px;">Edit {{ member.full_name }}</h1>
                <div class="muted">Member ID: {{ member.id|slice:":8" }}...</div>
            </div>
        </div>
        <div class="actions">
            <a href="{% url 'member_detail' member.id %}" class="pill">‚Üê View Profile</a>
            <a href="{% url 'member_list' %}" class="pill">Back to List</a>
        </div>
    </div>

    {% if errors %}
    <div class="card" style="background:#fee2e2; border-color:#dc2626; margin-bottom:20px;">
        <h3 style="margin-top:0; color:#dc2626;">‚ö†Ô∏è Please fix the following errors:</h3>
        <ul style="color:#dc2626; padding-left:20px;">
            {% for field, error_list in errors.items %}
                {% for error in error_list %}
                    <li><strong>{{ field|title }}:</strong> {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="form-grid">
            <!-- Photo & Basic Info -->
            <div class="form-section">
                <h3>üñºÔ∏è Member Photo</h3>
                <div class="current-photo">
                    {% if member.photo %}
                        <img src="{{ member.photo.url }}" alt="{{ member.full_name }}" class="photo-preview">
                        <div class="muted">Current photo</div>
                    {% else %}
                        <div style="width:120px; height:120px; border-radius:50%; background:#e0e7ff; 
                                    display:grid; place-items:center; font-size:36px; color:#3730a3;">
                            {{ member.first_name|slice:":1"|upper }}{{ member.last_name|slice:":1"|upper }}
                        </div>
                        <div class="muted">No photo uploaded</div>
                    {% endif %}
                    <div class="photo-upload" onclick="document.getElementById('photo').click()" 
                         style="margin-top:12px;">
                        <div>üì∏ Change Photo</div>
                        <input type="file" id="photo" name="photo" accept="image/*" style="display:none;">
                    </div>
                </div>
            </div>

            <!-- Personal Information -->
            <div class="form-section">
                <h3>üë§ Personal Information</h3>
                <div style="display:grid; gap:14px;">
                    <div>
                        <label for="first_name" class="required">First Name</label>
                        <input type="text" id="first_name" name="first_name" 
                               value="{{ member.first_name }}" required>
                    </div>
                    <div>
                        <label for="last_name" class="required">Last Name</label>
                        <input type="text" id="last_name" name="last_name" 
                               value="{{ member.last_name }}" required>
                    </div>
                    <div>
                        <label for="gender">Gender</label>
                        <select id="gender" name="gender">
                            <option value="">Select gender</option>
                            {% for value, label in gender_choices %}
                                <option value="{{ value }}" {% if member.gender == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="date_of_birth">Date of Birth</label>
                        <input type="date" id="date_of_birth" name="date_of_birth" 
                               value="{{ member.date_of_birth|date:'Y-m-d'|default:'' }}">
                    </div>
                </div>
            </div>

            <!-- Contact Information -->
            <div class="form-section">
                <h3>üìû Contact Information</h3>
                <div style="display:grid; gap:14px;">
                    <div>
                        <label for="email">Email Address</label>
                        <input type="email" id="email" name="email" 
                               value="{{ member.email|default:'' }}">
                    </div>
                    <div>
                        <label for="phone">Phone Number</label>
                        <input type="tel" id="phone" name="phone" 
                               value="{{ member.phone|default:'' }}" placeholder="+234XXXXXXXXXX">
                    </div>
                    <div>
                        <label for="address">Address</label>
                        <textarea id="address" name="address" 
                                  placeholder="Street, area, city">{{ member.address|default:'' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- Church Information -->
            <div class="form-section">
                <h3>‚õ™ Church Information</h3>
                <div style="display:grid; gap:14px;">
                    <div>
                        <label for="status" class="required">Member Status</label>
                        <select id="status" name="status" required>
                            {% for value, label in status_choices %}
                                <option value="{{ value }}" {% if member.status == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="join_date">Join Date</label>
                        <input type="date" id="join_date" name="join_date" 
                               value="{{ member.join_date|date:'Y-m-d'|default:'' }}">
                    </div>
                    <div>
                        <label for="campus">Campus</label>
                        <select id="campus" name="campus">
                            <option value="">Select campus</option>
                            {% for campus in campuses %}
                                <option value="{{ campus.id }}" {% if member.campus_id == campus.id %}selected{% endif %}>
                                    {{ campus.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Family Information -->
            <div class="form-section">
                <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Information</h3>
                <div style="display:grid; gap:14px;">
                    <div>
                        <label for="family">Family</label>
                        <select id="family" name="family">
                            <option value="">Select family</option>
                            {% for family in families %}
                                <option value="{{ family.id }}" {% if member.family_id == family.id %}selected{% endif %}>
                                    {{ family.family_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="family_role">Family Role</label>
                        <select id="family_role" name="family_role">
                            <option value="">Select role</option>
                            {% for value, label in family_role_choices %}
                                <option value="{{ value }}" {% if member.family_role == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="spouse">Spouse</label>
                        <select id="spouse" name="spouse">
                            <option value="">Select spouse</option>
                            {% for other in other_members %}
                                <option value="{{ other.id }}" {% if member.spouse_id == other.id %}selected{% endif %}>
                                    {{ other.full_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="marital_status">Marital Status</label>
                        <select id="marital_status" name="marital_status">
                            <option value="">Select status</option>
                            {% for value, label in marital_status_choices %}
                                <option value="{{ value }}" {% if member.marital_status == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Professional & Medical -->
            <div class="form-section">
                <h3>üíº Professional & Medical</h3>
                <div style="display:grid; gap:14px;">
                    <div>
                        <label for="occupation">Occupation</label>
                        <input type="text" id="occupation" name="occupation" 
                               value="{{ member.occupation|default:'' }}">
                    </div>
                    <div>
                        <label for="blood_type">Blood Type</label>
                        <select id="blood_type" name="blood_type">
                            <option value="">Select blood type</option>
                            {% for value, label in blood_type_choices %}
                                <option value="{{ value }}" {% if member.blood_type == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="baptism_status">Baptism Status</label>
                        <select id="baptism_status" name="baptism_status">
                            <option value="">Select baptism status</option>
                            {% for value, label in baptism_status_choices %}
                                <option value="{{ value }}" {% if member.baptism_status == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="baptism_date">Baptism Date</label>
                        <input type="date" id="baptism_date" name="baptism_date" 
                               value="{{ member.baptism_date|date:'Y-m-d'|default:'' }}">
                    </div>
                </div>
            </div>

            <!-- Location & Emergency Contact -->
            <div class="form-section">
                <h3>üìç Location & Emergency</h3>
                <div style="display:grid; gap:14px;">
                    <div>
                        <label for="residential_city">Residential City</label>
                        <input type="text" id="residential_city" name="residential_city" 
                               value="{{ member.residential_city|default:'' }}">
                    </div>
                    <div>
                        <label for="residential_state">Residential State</label>
                        <input type="text" id="residential_state" name="residential_state" 
                               value="{{ member.residential_state|default:'' }}">
                    </div>
                    <div>
                        <label for="next_of_kin_name">Next of Kin Name</label>
                        <input type="text" id="next_of_kin_name" name="next_of_kin_name" 
                               value="{{ member.next_of_kin_name|default:'' }}">
                    </div>
                    <div>
                        <label for="next_of_kin_phone">Next of Kin Phone</label>
                        <input type="tel" id="next_of_kin_phone" name="next_of_kin_phone" 
                               value="{{ member.next_of_kin_phone|default:'' }}">
                    </div>
                </div>
            </div>

            <!-- Departments -->
            <div class="form-section">
                <h3>üë• Departments</h3>
                <div style="display:grid; gap:14px;">
                    <div>
                        <label for="departments">Assign Departments</label>
                        <select id="departments" name="departments" multiple style="height:180px;">
                            {% for dept in departments %}
                                <option value="{{ dept.id }}" 
                                    {% if dept in member.departments.all %}selected{% endif %}>
                                    {{ dept.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="muted" style="margin-top:6px;">Hold Ctrl/Cmd to select multiple</div>
                    </div>
                </div>
            </div>

            <!-- Notes -->
            <div class="form-section">
                <h3>üìù Notes</h3>
                <div style="display:grid; gap:14px;">
                    <div>
                        <label for="notes">Internal Notes</label>
                        <textarea id="notes" name="notes" style="min-height:180px;">{{ member.notes|default:'' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:30px; padding-top:20px; border-top:2px solid var(--border);">
            <div>
                <a href="{% url 'member_detail' member.id %}" style="padding:12px 20px; border:1px solid var(--border); border-radius:10px;">Cancel</a>
            </div>
            <div style="display:flex; gap:12px;">
                <button type="submit" style="background:var(--primary);">Update Member</button>
            </div>
        </div>
    </form>

    <!-- Danger Zone -->
    {% if request.user.is_staff or request.user.is_owner or request.user.is_admin %}
    <div class="danger-zone">
        <h3 style="margin-top:0; color:#dc2626;">‚ö†Ô∏è Danger Zone</h3>
        <p style="margin-bottom:16px;">These actions are irreversible. Please proceed with caution.</p>
        <div style="display:flex; gap:12px;">
            <form method="post" action="{% url 'member_delete' member.id %}" 
                  onsubmit="return confirm('Are you sure you want to delete this member? This action cannot be undone.');"
                  style="margin:0;">
                {% csrf_token %}
                <button type="submit" style="background:#dc2626;">Delete Member</button>
            </form>
            <button onclick="if(confirm('Archive this member?')){ /* archive logic */ }" 
                    style="background:#f59e0b;">
                Archive Member
            </button>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Auto-format phone numbers
document.getElementById('phone')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.startsWith('234')) {
        value = '+' + value;
    } else if (value.startsWith('0')) {
        value = '+234' + value.substring(1);
    }
    e.target.value = value;
});
</script>
{% endblock %}